name: DevSecOps Agent Demo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: '3.11'

jobs:
  devsecops-demo:
    name: Security Scan & Auto-Fix Demo
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Reset demo file to vulnerable state for demonstration
      - name: Reset demo file to vulnerable state
        run: |
          echo "Resetting demo.py to vulnerable state..."
          cp vulnerable_examples/demo.py.template vulnerable_examples/demo.py
          echo "Demo file reset complete."

      # Run the agent ONLY on the demo file
      - name: Run DevSecOps Agent
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        run: |
          echo "Scanning vulnerable_examples/demo.py for security issues..."
          python -m src.agent.main vulnerable_examples/demo.py --fix --output security-report.json

      - name: Show scan results
        run: |
          echo "=== Security Scan Results ==="
          if [ -f security-report.json ]; then
            python -c "
          import json
          r = json.load(open('security-report.json'))
          print(f\"Vulnerabilities Found: {r.get('total_vulnerabilities', 0)}\")
          print(f\"Fixes Applied: {r.get('total_fixes', 0)}\")
          print(f\"Files Modified: {r.get('files_modified', [])}\")
          "
          fi

      - name: Check for fixes
        id: check-fixes
        run: |
          if git diff --quiet vulnerable_examples/demo.py; then
            echo "No changes detected in demo.py"
            echo "has_fixes=false" >> $GITHUB_OUTPUT
          else
            echo "Fixes were applied to demo.py"
            echo "has_fixes=true" >> $GITHUB_OUTPUT

            # Show the diff
            echo "=== Changes Made ==="
            git diff vulnerable_examples/demo.py
          fi

      - name: Commit and push fixes
        if: steps.check-fixes.outputs.has_fixes == 'true' && github.event_name == 'push'
        run: |
          git config user.name "DevSecOps Bot"
          git config user.email "devsecops-bot@users.noreply.github.com"

          git add vulnerable_examples/demo.py

          # Get fix summary
          FIX_COUNT=$(python -c "import json; r=json.load(open('security-report.json')); print(r.get('total_fixes', 0))" 2>/dev/null || echo "0")

          git commit -m "fix(security): auto-remediate vulnerabilities in demo.py

          DevSecOps Agent automatically fixed security vulnerabilities:

          - SQL Injection (CWE-89)
          - Command Injection (CWE-78)
          - Weak Cryptography (CWE-327)
          - Unsafe Deserialization (CWE-502)
          - Code Injection (CWE-95)

          This is a proof-of-concept demonstrating automated security fixes.

          Generated by DevSecOps Agent"

          git push

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            try {
              let comment = '## DevSecOps Agent - Security Scan Results\n\n';

              if (fs.existsSync('security-report.json')) {
                const report = JSON.parse(fs.readFileSync('security-report.json', 'utf8'));
                const vulns = report.total_vulnerabilities || 0;
                const fixes = report.total_fixes || 0;

                comment += `| Metric | Count |\n|--------|-------|\n`;
                comment += `| Vulnerabilities Found | ${vulns} |\n`;
                comment += `| Fixes Applied | ${fixes} |\n\n`;

                if (fixes > 0) {
                  comment += '### Vulnerabilities Fixed:\n';
                  comment += '- SQL Injection (CWE-89)\n';
                  comment += '- Command Injection (CWE-78)\n';
                  comment += '- Weak Cryptography (CWE-327)\n';
                  comment += '- Unsafe Deserialization (CWE-502)\n';
                  comment += '- Code Injection (CWE-95)\n\n';
                  comment += 'The agent has automatically generated secure code replacements.\n';
                }
              } else {
                comment += 'Security scan completed. Check workflow logs for details.\n';
              }

              comment += '\n---\n*Automated by [DevSecOps Agent](https://github.com/raphael-najee-monteiro/DevSecOps-automation)*';

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Could not post comment:', error);
            }