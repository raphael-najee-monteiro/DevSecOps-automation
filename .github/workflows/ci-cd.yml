name: DevSecOps Agent

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  devsecops-agent:
    name: Security Analysis with DevSecOps Agent
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run DevSecOps Agent
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python -m src.agent.main . --output security-report.json

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: security-report.json
          retention-days: 30

      - name: Comment on PR with findings
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            try {
              if (fs.existsSync('security-report.json')) {
                const report = JSON.parse(fs.readFileSync('security-report.json', 'utf8'));
                
                let comment = '## ðŸ”’ DevSecOps Agent Security Report\n\n';
                
                if (report.original_analysis && report.original_analysis.findings) {
                  const findings = report.original_analysis.findings;
                  comment += `**Vulnerabilities Found:** ${findings.length}\n\n`;
                  
                  if (findings.length > 0) {
                    comment += '### Findings:\n';
                    findings.forEach(f => {
                      comment += `- **${f.cwe_id}** (${f.severity}): ${f.description}\n`;
                    });
                  } else {
                    comment += 'âœ… **No vulnerabilities detected!**\n';
                  }
                } else {
                  comment += 'âœ… **Security scan completed successfully!**\n';
                }
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            } catch (error) {
              console.log('Could not post comment:', error);
            }