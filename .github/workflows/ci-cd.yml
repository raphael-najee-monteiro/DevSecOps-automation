name: DevSecOps Agent - Automated Security Scanning & CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security checks daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.11'
  CACHE_VERSION: 1

# Permissions for GitHub token
permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # ============================================================================
  # CODE QUALITY CHECKS
  # ============================================================================

  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black flake8 mypy ruff

      - name: Format check with Black
        run: black --check src/ test/
        continue-on-error: true

      - name: Lint with Flake8
        run: |
          flake8 src/ test/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src/ test/ --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics
        continue-on-error: true

      - name: Type check with mypy
        run: mypy src/ --ignore-missing-imports
        continue-on-error: true

      - name: Lint with Ruff
        run: ruff check src/ test/
        continue-on-error: true

  # ============================================================================
  # UNIT TESTS & COVERAGE
  # ============================================================================

  unit-tests:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    needs: code-quality

    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run unit tests with coverage
        run: |
          pytest test/test_agent.py \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ============================================================================
  # SECURITY SCANNING - TRADITIONAL TOOLS
  # ============================================================================

  security-scan-tools:
    name: Security Scanning (Bandit & Semgrep)
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit semgrep safety

      - name: Run Bandit security checks
        run: |
          bandit -r src/ -f json -o bandit-report.json
          bandit -r src/ -f txt
        continue-on-error: true

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/python
            p/owasp-top-ten

      - name: Check dependencies with Safety
        run: safety check --json
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            bandit-report.json
          retention-days: 30

  # ============================================================================
  # DEVSECOPS AGENT - AUTOMATED VULNERABILITY DETECTION & REPAIR
  # ============================================================================

  devsecops-agent:
    name: DevSecOps Agent - Security Analysis
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run DevSecOps Agent Security Scan
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Run the security agent on the project
          python -m src.agent.main . --output security-scan-report.json
        continue-on-error: true

      - name: Parse and Display Results
        if: always()
        run: |
          if [ -f security-scan-report.json ]; then
            echo "ðŸ“Š Security Scan Results:"
            python -c "
            import json
            with open('security-scan-report.json', 'r') as f:
              report = json.load(f)
            print(f\"Total files scanned: {report.get('total_files', 0)}\")
            print(f\"Total vulnerabilities: {report.get('total_vulnerabilities', 0)}\")
            print(f\"Total fixes applied: {report.get('total_fixes', 0)}\")
            
            # Show vulnerabilities by CWE
            if report.get('results'):
              for result in report['results']:
                if result.get('vulnerabilities_found', 0) > 0:
                  print(f\"\nâš ï¸  {result['file']}: {result['vulnerabilities_found']} vulnerabilities\")
                  for finding in result.get('findings', []):
                    print(f\"   - {finding['cwe']}: {finding['description']} (Line {finding['line']})\")
            "
          else
            echo "âŒ Security scan report not found"
          fi

      - name: Upload Agent Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: devsecops-agent-report
          path: security-scan-report.json
          retention-days: 30

      - name: Comment on PR with Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('security-scan-report.json')) {
              const report = JSON.parse(fs.readFileSync('security-scan-report.json', 'utf8'));
              const totalVulns = report.total_vulnerabilities || 0;
              const filesScanned = report.total_files || 0;
              
              let comment = `## ðŸ”’ DevSecOps Agent Security Report\n\n`;
              comment += `- **Files Scanned:** ${filesScanned}\n`;
              comment += `- **Vulnerabilities Found:** ${totalVulns}\n`;
              comment += `- **Fixes Applied:** ${report.total_fixes || 0}\n`;
              
              if (totalVulns === 0) {
                comment += `\nâœ… **All secure!** No vulnerabilities detected.`;
              } else {
                comment += `\nâš ï¸ **Review findings** - vulnerabilities detected`;
                comment += `\n\nDetails available in artifact: \`devsecops-agent-report\``;
              }
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  # ============================================================================
  # AGENT FUNCTIONALITY TESTS
  # ============================================================================

  agent-tests:
    name: Agent Functionality Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test CWE Database
        run: |
          python -c "
          from src.tools.cwe_database import CWEDatabase
          db = CWEDatabase()
          
          # Verify database loaded
          assert len(db.list_all_cwes()) > 0
          print(f'âœ“ CWE Database: {len(db.list_all_cwes())} CWEs loaded')
          
          # Test specific CWEs
          for cwe_id in ['CWE-89', 'CWE-79', 'CWE-78']:
              cwe = db.get_cwe(cwe_id)
              assert cwe is not None
              print(f'âœ“ {cwe_id}: {cwe[\"name\"]}')
          "

      - name: Test Prompt Templates
        run: |
          python -c "
          from src.agent.prompts import CoTPrompts, CWETemplates, RCIPrompts
          
          # Test template retrieval
          for cwe_id in ['CWE-89', 'CWE-79', 'CWE-78', 'CWE-327', 'CWE-732']:
              template = CWETemplates.get_template(cwe_id)
              assert template is not None
              print(f'âœ“ Template for {cwe_id} loaded')
          
          # Test prompt generation
          code = 'x = input()'
          prompt = CoTPrompts.analyze_vulnerability(
              code,
              {'cwe_id': 'CWE-89', 'severity': 'HIGH', 'description': 'Test'}
          )
          assert 'STEP 1' in prompt
          print('âœ“ CoT prompt generation works')
          "

      - name: Test Agent Configuration
        run: |
          python -c "
          from src.config import settings
          print(f'âœ“ Gemini Model: {settings.gemini_model}')
          print(f'âœ“ Data Directory: {settings.data_dir}')
          print(f'âœ“ CWE Database: {settings.cwe_database_path}')
          "

  # ============================================================================
  # INTEGRATION TESTS
  # ============================================================================

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [agent-tests, devsecops-agent]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test configuration system
        run: |
          python -c "
          from src.config import settings, validate_settings
          
          # Validate directories are created
          assert settings.data_dir.exists()
          assert settings.evaluation_dir.exists()
          print('âœ“ Configuration system working')
          print(f'âœ“ Data directory: {settings.data_dir}')
          print(f'âœ“ Evaluation directory: {settings.evaluation_dir}')
          "

      - name: Test logging system
        run: |
          python -c "
          from src.logger import get_logger
          
          logger = get_logger(__name__)
          assert logger is not None
          print('âœ“ Logging system initialized')
          "

      - name: Test CLI module entry point
        run: |
          python -c "
          from src.agent.main import get_python_files
          from pathlib import Path
          
          # Test file discovery
          files = get_python_files(Path('src'))
          assert len(files) > 0
          print(f'âœ“ Found {len(files)} Python files in src/')
          "

  # ============================================================================
  # DOCUMENTATION CHECKS
  # ============================================================================

  docs:
    name: Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ -f README.md ]; then
            echo "âœ“ README.md exists"
            wc -l README.md
          else
            echo "âœ— README.md missing"
            exit 1
          fi

      - name: Check docstrings
        run: |
          python -c "
          import ast
          import sys
          
          files = [
              'src/agent/security_agent.py',
              'src/agent/prompts.py',
              'src/tools/cwe_database.py',
              'src/config.py',
              'src/logger.py'
          ]
          
          for filepath in files:
              with open(filepath, 'r') as f:
                  tree = ast.parse(f.read(), filepath)
              
              # Count docstrings
              docstrings = 0
              for node in ast.walk(tree):
                  if isinstance(node, (ast.FunctionDef, ast.ClassDef)):
                      if ast.get_docstring(node):
                          docstrings += 1
              
              print(f'âœ“ {filepath}: {docstrings} documented elements')
          "

  # ============================================================================
  # BUILD & ARTIFACTS
  # ============================================================================

  build:
    name: Build & Package
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, security-scan-tools, agent-tests, devsecops-agent]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build wheel setuptools

      - name: Create distribution
        run: |
          python -m build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: python-package-distributions
          path: dist/

  # ============================================================================
  # FINAL STATUS CHECK
  # ============================================================================

  status-check:
    name: Status Check & Summary
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, security-scan-tools, agent-tests, devsecops-agent, integration-tests, build]
    if: always()

    steps:
      - name: Check build status
        run: |
          echo "ðŸ“Š Pipeline Status Report"
          echo "=========================="
          echo ""
          echo "âœ“ Code Quality: ${{ needs.code-quality.result }}"
          echo "âœ“ Unit Tests: ${{ needs.unit-tests.result }}"
          echo "âœ“ Security Scanning: ${{ needs.security-scan-tools.result }}"
          echo "âœ“ Agent Tests: ${{ needs.agent-tests.result }}"
          echo "âœ“ DevSecOps Agent: ${{ needs.devsecops-agent.result }}"
          echo "âœ“ Integration Tests: ${{ needs.integration-tests.result }}"
          echo "âœ“ Build: ${{ needs.build.result }}"
          echo ""
          
          # Check for failures
          if [ "${{ needs.code-quality.result }}" = "failure" ]; then
            echo "âŒ Code quality checks failed"
            exit 1
          fi
          
          if [ "${{ needs.unit-tests.result }}" = "failure" ]; then
            echo "âŒ Unit tests failed"
            exit 1
          fi
          
          if [ "${{ needs.devsecops-agent.result }}" = "failure" ]; then
            echo "âš ï¸  DevSecOps Agent failed (non-blocking)"
          fi
          
          echo ""
          echo "âœ… Pipeline Complete!"

      - name: Generate Summary
        run: |
          echo "## âœ… CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: **${{ needs.code-quality.result }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: **${{ needs.unit-tests.result }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scanning: **${{ needs.security-scan-tools.result }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Agent Tests: **${{ needs.agent-tests.result }}**" >> $GITHUB_STEP_SUMMARY
          echo "- DevSecOps Agent: **${{ needs.devsecops-agent.result }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: **${{ needs.integration-tests.result }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Build: **${{ needs.build.result }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          echo "- Security Reports" >> $GITHUB_STEP_SUMMARY
          echo "- DevSecOps Agent Report" >> $GITHUB_STEP_SUMMARY
          echo "- Python Package Distributions" >> $GITHUB_STEP_SUMMARY